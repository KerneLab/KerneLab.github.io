<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,height=device-height,initial-scale=0.75,minimum-scale=0.75,maximum-scale=2.0,user-scalable=yes">
<title>Evaluator</title>
<script src="https://unpkg.com/jquery@1/dist/jquery.min.js"></script>
<script src="https://unpkg.com/vue@2/dist/vue.min.js"></script>
<script src="https://unpkg.com/canal.js@1/canal.min.js"></script>
<script src="https://unpkg.com/codemirror@5/lib/codemirror.js""></script>
<script
	src="https://unpkg.com/codemirror@5/mode/javascript/javascript.js"></script>
<link rel="stylesheet"
	href="https://unpkg.com/codemirror@5/lib/codemirror.css">
<link rel="stylesheet"
	href="https://unpkg.com/codemirror@5/theme/eclipse.css">
<style>
body, div, textarea, span, th, td, a:link, a:visited, a:hover, a:active
	{
	font-size: 12px;
	color: #000;
}

body {
	margin: 3px;
	padding: 0px;
	background-color: #FFF;
}

.nowrap {
	white-space: nowrap;
}

div.part {
	border: 0px none #FFF;
	padding: 0px;
	margin-bottom: 3px;
}

table.frame, td.frame {
	border: 0px none #FFF;
	border-collapse: collapse;
	padding: 0px;
}

table.grid, th.grid, td.grid {
	border-width: 1px;
	border-style: solid;
	border-color: #999;
	border-collapse: collapse;
}

th.grid, td.grid {
	height: 23px;
	padding: 2px;
}

input.cell, textarea.cell {
	border: 0px none #FFF;
}

span.button {
	cursor: pointer;
}

.fixedhead {
	top: -1px;
	position: sticky;
	background-color: #FFF;
}

.CodeMirror {
	border: 1px solid #999;
	height: auto;
}

.CodeMirror-scroll {
	height: auto;
	max-height: 250px;
}
</style>
</head>
<body>

	<div id="main">
		<div class="part" style="width: 100%; overflow-x: auto">
			<table class="frame" style="width: 100%;">
				<tr valign="top">
					<td v-for="(s,i) in src" :key="i" class="frame"
						style="min-width: 220px; padding-right: 2px;">
						<table class="grid" style="width: 100%;">
							<tr>
								<td class="grid">
									<table class="frame" style="width: 100%">
										<tr>
											<td align="left" class="frame" style="width: 75%"><input
												v-model="s.id" class="cell" style="float: left; width: 100%"
												type="text" /></td>
											<td align="right" class="frame"><span class="button"
												@click="append(i)"
												style="font-size: 14px; font-weight: bold" title="Append">＋&nbsp;</span><span
												class="button" @click="remove(i)"
												style="font-size: 14px; font-weight: bold" title="Remove">×&nbsp;</span></td>
										</tr>
									</table>
								</td>
							</tr>
							<tr>
								<td class="grid"><textarea v-model="s.raw" class="cell"
										rows="8" wrap="off" style="width: 100%; overflow: auto;"></textarea>
								</td>
							</tr>
							<tr>
								<td class="grid">
									<table class="frame" style="width: 100%">
										<tr>
											<td align="left" class="frame"><label
												v-for="(t,j) in types" :key="j"><input
													v-model="s.type" type="radio" :value="t" />{{ t }}</label> <label><input
													v-model="s.head" type="checkbox" true-value="true"
													false-value="false" />head</label></td>
											<td align="right" class="frame"><a
												style="vertical-align: middle"
												href="https://github.com/KerneLab/Canal/wiki/API_Reference_CN"
												target="_blank">help</a></td>
										</tr>
									</table>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</div>
		<div class="part">
			<textarea v-model="expr" ref="exprText" rows="6" style="width: 100%;"></textarea>
		</div>
		<div class="part" style="color: #F00">{{ error }}</div>
		<div class="part">
			<table class="grid">
				<thead>
					<tr v-if="tableHead!=null" class="fixedhead">
						<th v-for="(head,h) in tableHead" class="grid">{{ head }}</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(row,r) in tableBody">
						<td v-for="(col,c) in row" class="grid nowrap"
							:style="stylesOfCell(col)">{{ col }}</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script type="text/javascript">
		new Vue(
				{
					el : "#main",
					data : {
						src : [ {
							"id" : "c",
							"raw" : "id\tdept\tname\tsex\tage" //
									+ "\n1\tA\tjohn\tM\t36" //
									+ "\n2\tB\tmike\tM\t31" //
									+ "\n3\tA\trose\tF\t28" //
									+ "\n4\tA\ttim\tM\t29" //
									+ "\n5\tB\tlucy\tF\t33",
							"type" : "tsv",
							"head" : "true"
						}, {
							"id" : "d",
							"raw" : "id, month, salary" //
									+ "\n1, 202101, 8000.00" //
									+ "\n2, 202101, 7500.00" //
									+ "\n3, 202101, 6700.00" //
									+ "\n4, 202101, 7200.00",
							"type" : "csv",
							"head" : "true"
						} ],
						expr : "c.select(\"*\", $(d=>parseInt(d.age)).as(\"age\")).keyBy(x=>x.id)" //
								+ "\n.leftJoin(d.select(\"*\", $(d=>parseInt(d.salary)).as(\"salary\")).keyBy(x=>x.id))" //
								+ "\n.mapJoint((ll,r) => {var l=Canal.Some(ll);return Canal.row(l.$(\"*\"),r.$(\"month\"),r.$(\"salary\"));})" //
								+ "\n.window(Canal.wf.sum(d=>d.salary).partBy(d=>d.dept).as(\"sum_sal\"))" //
								+ "\n.collect()",
						editor : null,
						error : null,
						types : [ "raw", "csv", "tsv" ],
						splitor : {
							"csv" : new RegExp("\\s*,\\s*", "g"),
							"tsv" : new RegExp("\t", "g")
						},
						lineSplit : new RegExp("\n", "g")
					},
					mounted : function()
					{
						var self = this;
						this.editor = CodeMirror.fromTextArea(this.$refs.exprText, {
							"mode" : "javascript",
							"lineNumbers" : true,
							"lineWrapping" : true,
							"indentWithTabs" : true,
							"smartIndent" : false,
							"tabSize" : 2,
							"viewportMargin" : Infinity
						});
						this.editor.on("change", function(e)
						{
							self.expr = e.getValue();
						});
					},
					computed : {
						ctx : function()
						{
							var self = this;
							var ctx = Canal.of(this.src).keyBy(function(d)
							{
								return d.id;
							}).mapValues(function(d)
							{
								return Canal.of(self.rows(d));
							}).collectAsMap();

							ctx["$"] = Canal.col;

							return ctx;
						},
						result : function()
						{
							try
							{
								this.error = null;

								var res = this.eval(this.expr, this.ctx);

								if (res instanceof Canal)
								{
									res = res.collect();
								}

								return res;
							}
							catch (err)
							{
								this.error = err;
								return this.rows;
							}
						},
						tableHead : function()
						{
							var res = this.result;
							if (!$.isArray(res) || res.length == 0)
							{
								return null;
							}

							var h = res[0];
							if ($.isPlainObject(h))
							{
								var head = [];
								for ( var k in h)
								{
									head.push(k);
								}
								return head;
							}
							else
							{
								return null;
							}
						},
						tableBody : function()
						{
							var res = this.result;
							if (!$.isArray(res) || res.length == 0)
							{
								return [ [ res ] ];
							}

							var head = this.tableHead;

							var h = res[0];
							if (head != null)
							{
								return Canal.of(res).map(function(d)
								{
									return Canal.of(head).map(function(k)
									{
										return d[k];
									}).collect();
								}).collect();
							}
							else if ($.isArray(h))
							{
								return res;
							}
							else
							{
								return Canal.of(res).map(function(d)
								{
									return [ d ];
								}).collect();
							}
						}
					},
					methods : {
						append : function(i)
						{
							this.src.splice(i + 1, 0, {
								"id" : String.fromCharCode("c".charCodeAt(0) + this.src.length),
								"raw" : "",
								"type" : "csv",
								"head" : "true"
							});
						},
						remove : function(i)
						{
							this.src.splice(i, 1);
						},
						lines : function(raw)
						{
							if (raw == null)
							{
								return [];
							}
							else
							{
								return raw.split(this.lineSplit);
							}
						},
						rows : function(src)
						{
							var lines = this.lines(src.raw);
							if ("raw" == src.type || lines.length == 0)
							{
								return lines;
							}

							var head = null;
							if (src.head == "true")
							{
								head = this.split(lines[0], src.type);
							}

							var self = this;
							var canal = Canal.of(lines);
							if (head != null)
							{
								canal = canal.skip(1);
							}
							return canal.map(function(line)
							{
								var row = self.split(line, src.type);
								if (head != null)
								{
									var r = {};
									for (var i = 0; i < head.length; i++)
									{
										r[head[i]] = row[i];
									}
									row = r;
								}
								return row;
							});
						},
						eval : function(code, ctx)
						{
							return (new Function('with(this){"use strict";\nreturn (' + code + '\n);}')).call(ctx);
						},
						split : function(line, type)
						{
							if (line == null || type == "raw")
							{
								return line;
							}
							var split = this.splitor[type];
							if (split == null)
							{
								return line;
							}
							else
							{
								return line.split(split);
							}
						},
						stylesOfCell : function(val)
						{
							var s = {
								'text-align' : typeof (val) === "number" ? "right" : "left"
							};

							if (val == null)
							{
								s['background-color'] = "#DDD";
							}

							return s;
						}
					}
				});
	</script>

</body>
</html>